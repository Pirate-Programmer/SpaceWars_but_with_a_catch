<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" id="favicon" href="images/0.ico">
    <title>SpaceWars</title>

    <style>
body {
    margin: 0;
    padding: 0;
    background: black;
    color: white;
    font-family: monospace, sans-serif;
    overflow: hidden;
}

/* Start message in center */
#message {
    position: fixed;
    top: 40%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 10px;
    font-weight: bold;
    animation: pulse 1.5s infinite;
    text-align: center;
}

/* Score + wave (top left) */
#scoreboard {
    position: fixed;
    top: 10px;
    left: 10px;
    font-size: 11px;
    line-height: 1.4;
}

#hud {
    position: fixed;
    top: 10px;
    left: 10px;
    font-size: 10px;
    line-height: 1.6;
    display: none;
    flex-direction: column;
}

#highscore {
    position: fixed;
    top: 10px;
    right: 10px;
    font-size: 10px;
    display: none;
}

#controls {
    position: fixed;
    top: 60%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 10px;
    line-height: 1.6;
    opacity: 0.7;
    text-align: center;
    display: none;
}

.hidden {
    display: none !important;
}

/* Heartbeat/pulse for start text */
@keyframes pulse {
    0%   { opacity: 1; transform: translate(-50%, -50%) scale(1); }
    50%  { opacity: 0.4; transform: translate(-50%, -50%) scale(1.1); }
    100% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
}

    @media screen and (max-width: 600px) {
        #message {
            font-size: 8px;
        }
        
        #hud {
            font-size: 9px;
        }
        
        #highscore {
            font-size: 9px;
        }
        
        #controls {
            font-size: 8px;
            top: 65%;  /* Move controls down a bit more */
        }
    }

    @media screen and (max-width: 400px) {
        #message {
            font-size: 7px;
        }
        
        #hud, #highscore {
            font-size: 8px;
        }
        
        #controls {
            font-size: 7px;
            top: 70%;
        }
    }
    </style>

    <script>
        let gameState = false;
        //get the favicon element
        const favicon = document.getElementById("favicon");   
        const favicon_height = 16;
        const favicon_width = 16; 


    </script>
    
</head>
<body>
    <canvas id="canvas">yo</canvas>
    
    <div id="message">Press SPACE to Begin</div>
    
    <div id="hud">
        <div id="score">Score: 0</div>
        <div id="wave">Wave: 1</div>
    </div>

    <div id="highscore">
        Highscore: 0
    </div>

    <div id="controls">
        Controls:<br>
        ← → to move<br>
        SPACE to shoot
    </div>


    <script>
        let triggerHit = false;
        const startMessage = document.getElementById("message");
        const hud = document.getElementById("hud");
        


        //function to start timer before gameplay
        //default param starts timer from 1
        //setTimeout(fn,delay): recursion the function is called at a delay of 1 seconds
        const countdown = function(curr = 1){   
            if(curr > 3)
            {
                favicon.href = `images/go.ico`;                
                setTimeout(() => {
                    intialState(); 
                    gameState = true;          
                }, 1000); 
                return;
            }

            favicon.href = `images/${curr}.ico`;
            setTimeout(() => countdown(curr + 1), 1000);
        };

    window.addEventListener("keydown", function (event) {
        if (event.key === " " && !triggerHit) {
            triggerHit = true;
            startMessage.style.display = "none";
            
            // Show all elements immediately
            hud.style.display = "block";
            document.getElementById("highscore").style.display = "block";
            document.getElementById("controls").style.display = "block";
            
            countdown();
        }
    });
    </script>


    <!-- Game Script -->
    <script>
        
         
        //just create img objects and set crossorigin propery
        function addImages(){
            const img = new Image();
            img.crossOrigin = "anonymous";
            return img;
        }

        //to ensure images are loaded correctly and not before i use em
        //reject and resolve are fn args of promise exuctor funtion they are provided by js
        //values in resovle and reject are args that are passed to .then fun on success of promise fun
        function loadImages(img,src){
            return new Promise((resolve,reject) => {
                img.onload = () => resolve(img);
                img.onerror = () => reject(new Error(`Failed to load image: ${src}`));
                img.src = src;
            });
        };



        let gameboard = addImages();
        let ship  = addImages();
        let alien = addImages();
        let bullet = addImages();

    


        //fetch the canvas element and set some defualt values
        const canvas = document.getElementById("canvas");
        canvas.width = favicon_width;
        canvas.height = favicon_height;
        const ctx = canvas.getContext("2d")
        ctx.imageSmoothingEnabled = false;
        
        //THIS HIDES THE CANVAS FROM DISPLAYING ON THE SCREEN
        canvas.style.display = "none";

        //game setting

        //ship coords
        //shipX has a range of [-6,8]
        //shipY is const (just above earth)
        
        let shipX = 0;
        const shipY =  2;
        const shipRightMax = 8;
        const shipLeftMax = -6;
        let shipSpeed = 7;


        //Rect Shape of Ship Sprite
        const shipRectX = 4;
        const shipRectY = 8 ;
        const shipRectWidth = 6;
        const shipRectHeight = 2;

        //intialAlienX cords range of [-6,0] , intialAlienX represents alien on the left side
        //second alien will be + 7px to the right of intialAlienX
        let alienX = 0;
        const alienY = -6;
        const alienBottomMax = 14;
        const alienLeftMax = -7; 
        const alienRightMax = 8;
        const alienTopMax = -6;

        //Rect shape of alien sprite
        const alienRectX = 5
        const alienRectY = 5;
        const alienRectWidth = 5;
        const alienRectHeight = 3;

        let alienSpeedX = 4;
        let alienSpeedY = 1;
        const alienIntialSpeedX = alienSpeedX;
        const alienIntialSpeedY = alienSpeedY;
        let direction = 1;
        
        
        let alien_count = 0;
        const max_alien_count = 2;
        let aliens = [];


        let bulletX = 0;
        let bulletY = 0;
        let bullet_count = 0;
        let bullet_speed = 6;
        const max_bullet_count = 2;
        const bullets = []


        //Rect for bullet sprite
        const bulletRectX = 7;
        const bulletRectY = 8;
        const bulletRectWidth = 1;
        const bulletRectHeight = 2;


        const positionsX = [-7,-6,-5,-4,-3,-2,-1,0,1,2,3,4,5,6,7,8];
        const positionsY = [-6,-5,-4,-3,-2,-1,0,1,2];
        

        function incGameDifficulty(){
            alienSpeedX *= 1.1;
            alienSpeedY *= 1.1;
        }

        
        function getRandomInt(max){
            return Math.floor(Math.random() * max);
        }


        function intialState(){
            //draw gameboard onto the canvas
            Promise.all([
                loadImages(gameboard,'./images/gameboard.png'),
                loadImages(ship,'./images/ship.png'),
                loadImages(alien,'./images/alien.png'),
                loadImages(bullet,"./images/bullet.png")
            ]).then(() => {
                //clear the canvas
                reset();

                ctx.clearRect(0,0,canvas.width,canvas.height);
                
                //draw gameboard and ship 
                ctx.drawImage(gameboard,0,0);

                shipX = (gameboard.width - ship.width) / 2 + 1;                
                ctx.drawImage(ship,shipX,shipY);

                
                const intialAlienX = positionsX[getRandomInt(positionsX.length - 8)];
                const intialAlienX2 = intialAlienX + 8;
                ctx.drawImage(alien,intialAlienX,alienY);
                ctx.drawImage(alien,intialAlienX2,alienY);

                aliens.push({x : intialAlienX, y : alienY});
                aliens.push({x : intialAlienX2, y: alienY});
                alien_count = 2;

                //testing bullet position
                ctx.drawImage(bullet,shipX,-2);

                //rip it to the faviconnnn
                favicon.href = canvas.toDataURL();
                console.log("Intial State Rendered!!");

                //intiate gameloop
                window.requestAnimationFrame(gameLoop);   
            });
        }

        //user input vars
        let left_arrow = false;
        let right_arrow = false;

        //event handler for user input
        window.addEventListener("keydown",function(event){
            if(gameState)
                return;

            if(event.key === ' '){
                shootbullets();
            }     
            if(event.key === 'ArrowRight')
                right_arrow = true;
            if(event.key === 'ArrowLeft')
                left_arrow = true;
        });

         window.addEventListener("keyup",function(event){

            if(event.key === 'ArrowRight')
                right_arrow = false;
            if(event.key === 'ArrowLeft')
                left_arrow = false;
        });


        //render canvas
        function render(){

            const ctx = canvas.getContext("2d");
            
            //clear the canvas
            ctx.clearRect(0,0,canvas.width,canvas.height);
            
            //draw gameboard
            ctx.drawImage(gameboard,0,0);
            
            //draw ship
            ctx.drawImage(ship,Math.round(shipX),shipY);
        
            //draw alien
            for(let i = 0; i < alien_count; i++){
                ctx.drawImage(alien,Math.round(aliens[i].x),Math.round(aliens[i].y));
            }

            for(let i = 0; i < bullet_count; i++){
                ctx.drawImage(bullet,Math.round(bullets[i].x),Math.round(bullets[i].y));
            }

            //rip it to the faviconnnn
            favicon.href = canvas.toDataURL();
            //console.log("New game Canvas Rendered!!");
        }


            //spawns bullet right above ship
        function shootbullets(){
            if(bullet_count < max_bullet_count){
                bullets.push({
                    x: shipX,
                    y: shipY - bulletRectHeight
                })
                bullet_count++;
            }
        }

        //Update canvas
        function updateGame(deltaTime){
            //spawn new alien_fleet no aliens remaining
            spawn_alien_fleet();

            //check for bullet alien collision
            alien_bullet_collision();

            //update positions
            updateShip(deltaTime);
            updateAlien(deltaTime);
            updateBullets(deltaTime);
        }

        //move ship left or right
        function updateShip(deltaTime){
            let newShipX = shipX;
            if(left_arrow)
                newShipX -= (shipSpeed * deltaTime);

            if(right_arrow)
                newShipX += (shipSpeed * deltaTime);

            if(newShipX < shipLeftMax)
                newShipX = shipLeftMax;
            if(newShipX > shipRightMax)
                newShipX = shipRightMax;

            shipX = newShipX;
        }

        function updateAlien(deltaTime){
            let flag = false;

            //update x coords of aliens based on direction flag
            //flip direction flag when boundary hit
            for(let i = 0;i < alien_count; i++){
                let newAlienX = aliens[i].x;

                newAlienX += direction * alienSpeedX * deltaTime;

                if (newAlienX < alienLeftMax) { 
                    newAlienX = alienLeftMax;
                    flag = true;     
                    direction *= -1;  
                } else if (newAlienX > alienRightMax) {
                    newAlienX = alienRightMax; 
                    flag = true;           
                    direction *= -1;         
                }
                
                aliens[i].x = newAlienX;
            }

            //update Y coords of aliens when boundary is hit
            if(flag){
                for(let i = 0;i < alien_count; i++)
                    aliens[i].y += alienSpeedY;
            }
        }

        //bullet travels in oppo direction 
        function updateBullets(deltaTime){
            for(let i = 0;i < bullet_count; i++){
                let y = bullets[i].y;

                y -=  deltaTime * bullet_speed;
                
                //then check if bullet is out of bounds
                if(y < -8){
                    bullets.splice(i,1);
                    bullet_count--;
                }
                else{
                    bullets[i].y = y;
                }
            }
        }
 
        function alien_bullet_collision(){
            aliens = aliens.filter(function(alienObj){
                for(let i = 0;i < bullet_count; i++){
                    if(collision(alienObj,"alien",bullets[i],"bullet")){
                        return false;
                    }
                }
                return true;
            });
            alien_count = aliens.length;
        }

        //spawn fresh fleet when all aliens defeated
        //increase game diffcult every time when new spawn 
        function spawn_alien_fleet(){
            if(alien_count !== 0)
                return;

            const intialAlienX = positionsX[getRandomInt(positionsX.length - 8)];
            const intialAlienX2 = intialAlienX + 8;
            
            aliens.push({x : intialAlienX, y : alienY});
            aliens.push({x : intialAlienX2, y: alienY});
            alien_count = 2;

            incGameDifficulty();
        }


        //fetch the actual coords of the objects 
        function getHitbox(obj, type) {
            let offsetX, offsetY, width, height;

            switch (type) {
                case "ship":
                    offsetX = shipRectX;
                    offsetY = shipRectY;
                    width = shipRectWidth;
                    height = shipRectHeight;
                    break;
                case "alien":
                    offsetX = alienRectX;
                    offsetY = alienRectY;
                    width = alienRectWidth;
                    height = alienRectHeight;
                    break;
                case "bullet":
                    offsetX = bulletRectX;
                    offsetY = bulletRectY;
                    width = bulletRectWidth;
                    height = bulletRectHeight;
                    break;
                }
                return {
                left: obj.x + offsetX,
                right: obj.x + offsetX + width,
                top: obj.y + offsetY,
                bottom: obj.y + offsetY + height,
            };
        }

        //check collision between two objects
        function collision(obj1,type1,obj2,type2){
            const rect1 = getHitbox(obj1,type1);
            const rect2 = getHitbox(obj2,type2);

            const xOverlap = rect1.right > rect2.left && rect1.left < rect2.right;
            const yOverlap = rect1.bottom > rect2.top && rect1.top < rect2.bottom;

            return xOverlap && yOverlap;
        }
        
        //when alien reaches the bottom or hits the ship
        function gameover(){
            if(alien_count === 0)
                return false;
            // Check each alien to see if it causes a game over condition
            for(let i = 0;i < alien_count; i++){
                const alienObj = aliens[i];
   
                const hasReachedBottom = (alienObj.y + alienRectY + alienRectHeight) >= alienBottomMax;

                if (hasReachedBottom || collision({x : shipX, y : shipY}, "ship", alienObj, "alien")) {
                    return true; 
                }
            }
            return false; 
        }       

    //reset everything to default state
    function reset(){
        alienSpeedX = alienIntialSpeedX;
        alienSpeedY = alienIntialSpeedY;
        aliens.splice(0,aliens.length);
        bullets.splice(0,bullets.length);
        alien_count = 0;
        bullet_count = 0;
        gameState = false;
        triggerHit = false;
    }


        //yeah this the main function!!!
        let lastTime = 0; 
        function gameLoop(timeStamp){
                        
            window.requestAnimationFrame(gameLoop);

            if(gameState)
                return; 

            const deltaTime = (timeStamp - lastTime) / 1000;
            lastTime = timeStamp; //this will be used for next frame

            //update canvas
            updateGame(deltaTime);
            
            //render canvas
            render();
            
            //check if gameover 
            if(gameover()){
                reset();
                console.log("gameover D:");
                return;
            }

        }

        //intialState();
    </script>
</body> 
</html>